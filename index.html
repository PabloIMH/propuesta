<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCRIM MANAGER 3.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 11, 46, 0.95) 50%, rgba(22, 0, 59, 0.95) 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cloudfront-us-east-1.images.arcpublishing.com/copesa/U7ECE2CH7NGAZNDXS3NM7BLLKQ.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.15;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #00ffff;
            margin-top: 10px;
            letter-spacing: 3px;
        }

        .tournament-progress {
            text-align: center;
            font-size: 1.3rem;
            color: #ff00ff;
            margin-top: 10px;
            font-family: 'Orbitron', sans-serif;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: #00ffff;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: #ff00ff;
            margin: 20px 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            background: rgba(10, 10, 30, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #00ffff, #0099ff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff0080, #ff0040);
        }

        .btn-success {
            background: linear-gradient(45deg, #00ff88, #00cc66);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffaa00, #ff6600);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 30px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #00ffff;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #00ffff, #0099ff);
            color: #000;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .all-players {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 8px;
            border: 2px dashed rgba(255, 0, 255, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .player-card {
            padding: 12px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(100, 100, 150, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1rem;
            animation: playerAppear 0.4s ease;
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .player-card.selected {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        .player-card .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ff0040;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .player-card:hover .delete-btn {
            opacity: 1;
        }

        .player-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 80px;
            padding: 15px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 8px;
            border: 2px dashed rgba(0, 255, 255, 0.2);
        }

        .player-tag {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border: 1px solid rgba(0, 255, 255, 0.5);
            border-radius: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: playerAppear 0.4s ease;
            transition: all 0.3s ease;
        }

        .player-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .player-tag .remove {
            cursor: pointer;
            color: #ff0080;
            font-weight: bold;
            font-size: 1.2rem;
        }

        @keyframes playerAppear {
            from {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }

            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .team {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .team.blue {
            border: 3px solid rgba(0, 150, 255, 0.6);
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.3);
        }

        .team.red {
            border: 3px solid rgba(255, 0, 80, 0.6);
            box-shadow: 0 0 30px rgba(255, 0, 80, 0.3);
        }

        .team::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: teamGlow 4s ease-in-out infinite;
        }

        @keyframes teamGlow {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(10%, 10%);
            }
        }

        .team-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .team.blue .team-title {
            color: #0096ff;
            text-shadow: 0 0 20px rgba(0, 150, 255, 0.8);
        }

        .team.red .team-title {
            color: #ff0080;
            text-shadow: 0 0 20px rgba(255, 0, 80, 0.8);
        }

        .team-players {
            list-style: none;
            position: relative;
            z-index: 1;
        }

        .team-players li {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1.2rem;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .winner-btns {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
        }

        .leaderboard {
            margin-top: 40px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            overflow: hidden;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            padding: 15px;
            text-align: left;
            font-size: 1.2rem;
            font-family: 'Orbitron', sans-serif;
            color: #00ffff;
            text-transform: uppercase;
        }

        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            font-size: 1.1rem;
        }

        .leaderboard-table tr:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        .rank {
            font-weight: 700;
            font-size: 1.3rem;
        }

        .rank.gold {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .rank.silver {
            color: #c0c0c0;
            text-shadow: 0 0 10px #c0c0c0;
        }

        .rank.bronze {
            color: #cd7f32;
            text-shadow: 0 0 10px #cd7f32;
        }

        .shuffle-animation {
            animation: shuffle 0.5s ease;
        }

        @keyframes shuffle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        .victory-animation {
            animation: victory 1s ease;
        }

        @keyframes victory {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 50px currentColor;
            }

            100% {
                transform: scale(1);
            }
        }

        .hidden {
            display: none;
        }

        /* Custom Alert */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(20, 20, 40, 0.98);
            border: 3px solid rgba(0, 255, 255, 0.6);
            border-radius: 20px;
            padding: 40px;
            min-width: 400px;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            z-index: 10000;
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .custom-alert.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .custom-alert .alert-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: #00ffff;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
        }

        .custom-alert .alert-message {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }

        .custom-alert .alert-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .alert-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* History Table */
        .history-section {
            margin-top: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            overflow: hidden;
        }

        .history-table th {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(0, 255, 255, 0.2));
            padding: 15px;
            text-align: left;
            font-size: 1.1rem;
            font-family: 'Orbitron', sans-serif;
            color: #ff00ff;
            text-transform: uppercase;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 0, 255, 0.1);
            font-size: 1rem;
        }

        .history-table tr:hover {
            background: rgba(255, 0, 255, 0.1);
        }

        @media (max-width: 968px) {

            .main-grid,
            .teams-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }

            .all-players {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .custom-alert {
                min-width: 90%;
            }
        }
    </style>
</head>

<body>
    <div class="alert-overlay" id="alertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <div class="alert-title" id="alertTitle">T√≠tulo</div>
        <div class="alert-message" id="alertMessage">Mensaje</div>
        <div class="alert-buttons" id="alertButtons"></div>
    </div>

    <div class="container">
        <header>
            <h1>‚öîÔ∏è SCRIMS ANTIVENEKOS ‚öîÔ∏è</h1>
            <div class="subtitle">SISTEMA DE TORNEOS V3.0</div>
            <div class="tournament-progress" id="tournamentProgress">Sin torneo activo</div>
        </header>

        <div class="main-grid">
            <div class="card">
                <h2 class="card-title">üéÆ LOBBY</h2>

                <!-- Agregar nuevo jugador -->
                <div class="input-group">
                    <input type="text" id="playerInput" placeholder="Agregar nuevo jugador...">
                    <button class="btn btn-small" onclick="addNewPlayer()">+ GUARDAR</button>
                </div>

                <!-- Selector de modo -->
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setMode(3)">3v3</button>
                    <button class="mode-btn" onclick="setMode(4)">4v4</button>
                    <button class="mode-btn" onclick="setMode(5)">5v5</button>
                </div>

                <!-- Todos los jugadores guardados -->
                <h3 class="section-title">üë• JUGADORES GUARDADOS</h3>
                <div class="all-players" id="allPlayers">
                    <!-- Saved players will appear here -->
                </div>

                <!-- Jugadores seleccionados para esta partida -->
                <h3 class="section-title">‚öîÔ∏è LOBBY ACTUAL</h3>
                <div class="player-pool" id="playerPool">
                    <div style="color: rgba(255,255,255,0.3); width: 100%; text-align: center;">
                        Selecciona jugadores arriba...
                    </div>
                </div>

                <button class="btn" style="width: 100%; margin-top: 20px;" onclick="generateTeams()">
                    üé≤ GENERAR EQUIPOS
                </button>

                <button class="btn btn-warning" style="width: 100%; margin-top: 10px;"
                    onclick="confirmResetTournament()">
                    üîÑ REINICIAR TORNEO
                </button>
            </div>

            <div class="card">
                <h2 class="card-title">üèÜ TABLA ACTUAL</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>JUGADOR</th>
                            <th>PUNTOS</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr>
                            <td colspan="3" style="text-align: center; color: rgba(255,255,255,0.3);">Sin jugadores en
                                el torneo</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="teamsSection" class="hidden">
            <div class="teams-container">
                <div class="team blue">
                    <h3 class="team-title">üíô EQUIPO AZUL</h3>
                    <ul class="team-players" id="blueTeam"></ul>
                </div>

                <div class="team red">
                    <h3 class="team-title">‚ù§Ô∏è EQUIPO ROJO</h3>
                    <ul class="team-players" id="redTeam"></ul>
                </div>
            </div>

            <div class="winner-btns">
                <button class="btn btn-success" onclick="declareWinner('blue')">
                    GAN√ì AZUL üíô
                </button>
                <button class="btn btn-danger" onclick="declareWinner('red')">
                    GAN√ì ROJO ‚ù§Ô∏è
                </button>
            </div>
        </div>

        <!-- Historial de Torneos -->
        <div class="card history-section">
            <h2 class="card-title">üìú HISTORIAL DE TORNEOS</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>FECHA</th>
                        <th>ü•á PRIMERO</th>
                        <th>ü•à SEGUNDO</th>
                        <th>ü•â TERCERO</th>
                        <th>PARTIDAS</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: rgba(255,255,255,0.3);">Sin torneos
                            registrados</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxn_GndimS5u5kVmXdc0BNv4Zn-0ZifzjO3OGbHbZZUzHIBdOlo3zO-myRQoZG67Yj0uA/exec';

        let allPlayers = {}; // Todos los jugadores guardados permanentemente
        let tournamentPlayers = {}; // Jugadores del torneo actual con puntos
        let selectedPlayers = []; // Jugadores seleccionados para lobby
        let mode = 3;
        let blueTeam = [];
        let redTeam = [];
        let allCombinations = [];
        let usedCombinations = [];
        let currentCombinationIndex = 0;
        let tournamentHistory = [];
        let tournamentActive = false;

        // ========== SISTEMA DE ALERTAS CUSTOM ==========
        function showAlert(title, message, buttons = [{ text: 'OK', action: null }]) {
            const overlay = document.getElementById('alertOverlay');
            const alert = document.getElementById('customAlert');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            const alertButtons = document.getElementById('alertButtons');

            alertTitle.textContent = title;
            alertMessage.textContent = message;

            alertButtons.innerHTML = buttons.map((btn, index) =>
                `<button class="btn ${btn.danger ? 'btn-danger' : ''}" onclick="handleAlertButton(${index})">${btn.text}</button>`
            ).join('');

            window.alertActions = buttons.map(btn => btn.action);

            overlay.classList.add('show');
            alert.classList.add('show');
        }

        function hideAlert() {
            const overlay = document.getElementById('alertOverlay');
            const alert = document.getElementById('customAlert');
            overlay.classList.remove('show');
            alert.classList.remove('show');
        }

        function handleAlertButton(index) {
            const action = window.alertActions[index];
            hideAlert();
            if (action) action();
        }

        // ========== CARGAR DATOS DESDE GOOGLE SHEETS ==========
        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const data = await response.json();

                // Cargar jugadores guardados
                if (data.players && data.players.length > 0) {
                    allPlayers = {};
                    data.players.forEach(player => {
                        if (player.nick) {
                            allPlayers[player.nick] = {
                                exists: true
                            };
                        }
                    });
                }

                // Cargar estado del torneo actual
                if (data.tournament) {
                    tournamentPlayers = data.tournament.players || {};
                    usedCombinations = data.tournament.usedCombinations || [];
                    mode = data.tournament.mode || 3;
                    tournamentActive = Object.keys(tournamentPlayers).length > 0;

                    if (tournamentActive) {
                        selectedPlayers = Object.keys(tournamentPlayers);
                        generateAllCombinations();
                        currentCombinationIndex = usedCombinations.length;
                    }
                }

                // Cargar historial
                if (data.history && data.history.length > 0) {
                    tournamentHistory = data.history;
                }

                renderAllPlayers();
                renderPlayerPool();
                updateLeaderboard();
                updateTournamentProgress();
                updateHistory();

                // Setear modo activo
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.mode-btn')[mode - 3].classList.add('active');

            } catch (error) {
                console.log('Error cargando datos:', error);
            }
        }

        // ========== GUARDAR EN GOOGLE SHEETS ==========
        async function saveToSheet() {
            try {
                const data = {
                    players: Object.keys(allPlayers).map(nick => ({ nick })),
                    tournament: {
                        players: tournamentPlayers,
                        usedCombinations: usedCombinations,
                        mode: mode
                    },
                    history: tournamentHistory
                };

                console.log('üì§ Enviando datos:', data); // Para ver qu√© enviamos

                const response = await fetch(SHEET_URL + '?action=save', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const text = await response.text();
                console.log('‚úÖ Respuesta del servidor:', text);

            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showAlert('‚ö†Ô∏è ERROR', 'No se pudo guardar en Google Sheets. Revisa la consola.');
            }
        }

        // ========== GESTI√ìN DE JUGADORES ==========
        function renderAllPlayers() {
            const container = document.getElementById('allPlayers');
            const players = Object.keys(allPlayers).sort();

            if (players.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.3);">No hay jugadores guardados</div>';
                return;
            }

            container.innerHTML = players.map(nick => `
        <div class="player-card ${selectedPlayers.includes(nick) ? 'selected' : ''} ${tournamentActive && !selectedPlayers.includes(nick) ? 'disabled' : ''}" 
             onclick="${tournamentActive && !selectedPlayers.includes(nick) ? '' : `togglePlayer('${nick}')`}">
            ${nick}
            <div class="delete-btn" onclick="event.stopPropagation(); confirmDeletePlayer('${nick}')">‚úï</div>
        </div>
    `).join('');
        }

        function togglePlayer(nick) {
            if (tournamentActive) {
                showAlert('‚ö†Ô∏è TORNEO ACTIVO', 'No puedes modificar el lobby durante un torneo en progreso.');
                return;
            }

            if (selectedPlayers.includes(nick)) {
                selectedPlayers = selectedPlayers.filter(p => p !== nick);
                delete tournamentPlayers[nick];
            } else {
                selectedPlayers.push(nick);
                tournamentPlayers[nick] = { points: 0 };
            }

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();
        }

        function renderPlayerPool() {
            const pool = document.getElementById('playerPool');

            if (selectedPlayers.length === 0) {
                pool.innerHTML = '<div style="color: rgba(255,255,255,0.3); width: 100%; text-align: center;">Selecciona jugadores arriba...</div>';
                return;
            }

            pool.innerHTML = selectedPlayers.map(p => `
        <div class="player-tag">
            <span>${p}</span>
            <span class="remove" onclick="togglePlayer('${p}')">‚úï</span>
        </div>
    `).join('');
        }

        async function addNewPlayer() {
            const input = document.getElementById('playerInput');
            const nick = input.value.trim();

            if (!nick) {
                showAlert('‚ö†Ô∏è ERROR', 'Por favor escribe un nombre de jugador.');
                return;
            }

            if (allPlayers[nick]) {
                showAlert('‚ö†Ô∏è YA EXISTE', `El jugador "${nick}" ya est√° guardado.`);
                return;
            }

            allPlayers[nick] = { exists: true };

            await saveToSheet();

            renderAllPlayers();
            input.value = '';

            showAlert('‚úÖ GUARDADO', `¬°Jugador "${nick}" agregado exitosamente!`);
        }

        function confirmDeletePlayer(nick) {
            showAlert(
                '‚ö†Ô∏è CONFIRMAR',
                `¬øEliminar permanentemente a "${nick}"?`,
                [
                    { text: 'CANCELAR', action: null },
                    { text: 'ELIMINAR', danger: true, action: () => deletePlayer(nick) }
                ]
            );
        }

        async function deletePlayer(nick) {
            delete allPlayers[nick];
            selectedPlayers = selectedPlayers.filter(p => p !== nick);
            delete tournamentPlayers[nick];

            await saveToSheet();

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();

            showAlert('‚úÖ ELIMINADO', `Jugador "${nick}" eliminado correctamente.`);
        }

        // ========== SELECTOR DE MODO ==========
        function setMode(newMode) {
            if (tournamentActive) {
                showAlert('‚ö†Ô∏è TORNEO ACTIVO', 'No puedes cambiar el modo durante un torneo en progreso.');
                return;
            }

            mode = newMode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ========== SISTEMA DE COMBINACIONES ==========
        function generateAllCombinations() {
            const players = [...selectedPlayers];
            const teamSize = mode;
            allCombinations = [];

            // Generar todas las combinaciones posibles
            function combine(arr, size) {
                const result = [];

                function helper(start, combo) {
                    if (combo.length === size) {
                        result.push([...combo]);
                        return;
                    }

                    for (let i = start; i < arr.length; i++) {
                        combo.push(arr[i]);
                        helper(i + 1, combo);
                        combo.pop();
                    }
                }

                helper(0, []);
                return result;
            }

            const team1Combos = combine(players, teamSize);

            team1Combos.forEach(team1 => {
                const team2 = players.filter(p => !team1.includes(p));
                if (team2.length === teamSize) {
                    // Evitar duplicados (A vs B es igual a B vs A)
                    const combo = {
                        blue: team1.sort(),
                        red: team2.sort()
                    };

                    const comboStr = JSON.stringify(combo);
                    const reverseCombo = JSON.stringify({ blue: combo.red, red: combo.blue });

                    if (!allCombinations.some(c =>
                        JSON.stringify(c) === comboStr || JSON.stringify(c) === reverseCombo
                    )) {
                        allCombinations.push(combo);
                    }
                }
            });
        }

        function getNextCombination() {
            if (!allCombinations.length) {
                generateAllCombinations();
            }

            if (usedCombinations.length >= allCombinations.length) {
                // Se complet√≥ el ciclo, reiniciar
                usedCombinations = [];
                currentCombinationIndex = 0;
                showAlert('üîÑ CICLO COMPLETO', '¬°Se jugaron todas las combinaciones posibles! Reiniciando ciclo...');
            }

            const nextCombo = allCombinations[currentCombinationIndex];
            usedCombinations.push(currentCombinationIndex);
            currentCombinationIndex++;

            return nextCombo;
        }

        // ========== GENERAR EQUIPOS ==========
        function generateTeams() {
            const required = mode * 2;

            if (selectedPlayers.length < required) {
                showAlert('‚ö†Ô∏è JUGADORES INSUFICIENTES', `Necesitas ${required} jugadores para el modo ${mode}v${mode}.`);
                return;
            }

            if (!tournamentActive) {
                // Iniciar nuevo torneo
                tournamentActive = true;
                usedCombinations = [];
                currentCombinationIndex = 0;

                // Resetear puntos
                selectedPlayers.forEach(p => {
                    tournamentPlayers[p] = { points: 0 };
                });

                generateAllCombinations();
            }

            const pool = document.getElementById('playerPool');
            pool.classList.add('shuffle-animation');

            setTimeout(() => {
                const combo = getNextCombination();
                blueTeam = combo.blue;
                redTeam = combo.red;

                document.getElementById('blueTeam').innerHTML = blueTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');
                document.getElementById('redTeam').innerHTML = redTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');

                document.getElementById('teamsSection').classList.remove('hidden');
                pool.classList.remove('shuffle-animation');

                updateTournamentProgress();
                saveToSheet();
            }, 500);
        }

        // ========== DECLARAR GANADOR ==========
        async function declareWinner(team) {
            const winners = team === 'blue' ? blueTeam : redTeam;
            const teamElement = document.querySelector(`.team.${team}`);

            teamElement.classList.add('victory-animation');

            winners.forEach(player => {
                if (tournamentPlayers[player]) {
                    tournamentPlayers[player].points += 1;
                }
            });

            await saveToSheet();
            updateLeaderboard();
            updateTournamentProgress();

            setTimeout(() => {
                resetMatch();
                teamElement.classList.remove('victory-animation');
            }, 1000);
        }

        // ========== ACTUALIZAR TABLA ==========
        function updateLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            const sorted = Object.entries(tournamentPlayers)
                .sort((a, b) => b[1].points - a[1].points);

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: rgba(255,255,255,0.3);">Sin jugadores en el torneo</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(([nick, stats], index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';

                return `
            <tr>
                <td class="rank ${rankClass}">${index + 1}</td>
                <td>${nick}</td>
                <td>${stats.points}</td>
            </tr>
        `;
            }).join('');
        }

        // ========== PROGRESO DEL TORNEO ==========
        function updateTournamentProgress() {
            const progress = document.getElementById('tournamentProgress');

            if (!tournamentActive || allCombinations.length === 0) {
                progress.textContent = 'Sin torneo activo';
                return;
            }

            progress.textContent = `üéÆ Partida ${usedCombinations.length}/${allCombinations.length} combinaciones`;
        }

        // ========== REINICIAR TORNEO ==========
        function confirmResetTournament() {
            if (!tournamentActive) {
                showAlert('‚ö†Ô∏è SIN TORNEO', 'No hay ning√∫n torneo activo para reiniciar.');
                return;
            }

            showAlert(
                '‚ö†Ô∏è REINICIAR TORNEO',
                '¬øGuardar este torneo en el historial y comenzar uno nuevo?',
                [
                    { text: 'CANCELAR', action: null },
                    { text: 'REINICIAR', danger: true, action: resetTournament }
                ]
            );
        }

        async function resetTournament() {
            // Guardar en historial
            const sorted = Object.entries(tournamentPlayers)
                .sort((a, b) => b[1].points - a[1].points);

            const top3 = sorted.slice(0, 3);

            const historyEntry = {
                date: new Date().toLocaleString('es-CL'),
                first: top3[0] ? { nick: top3[0][0], points: top3[0][1].points } : null,
                second: top3[1] ? { nick: top3[1][0], points: top3[1][1].points } : null,
                third: top3[2] ? { nick: top3[2][0], points: top3[2][1].points } : null,
                matches: `${usedCombinations.length}/${allCombinations.length}`
            };

            tournamentHistory.unshift(historyEntry);

            // Resetear todo
            tournamentPlayers = {};
            selectedPlayers = [];
            usedCombinations = [];
            currentCombinationIndex = 0;
            allCombinations = [];
            tournamentActive = false;
            blueTeam = [];
            redTeam = [];

            await saveToSheet();

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();
            updateTournamentProgress();
            updateHistory();
            document.getElementById('teamsSection').classList.add('hidden');

            showAlert('‚úÖ TORNEO GUARDADO', '¬°Torneo guardado en el historial! Puedes iniciar uno nuevo.');
        }

        // ========== HISTORIAL ==========
        function updateHistory() {
            const tbody = document.getElementById('historyBody');

            if (tournamentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.3);">Sin torneos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = tournamentHistory.map(entry => `
        <tr>
            <td>${entry.date}</td>
            <td>${entry.first ? `${entry.first.nick} (${entry.first.points})` : '-'}</td>
            <td>${entry.second ? `${entry.second.nick} (${entry.second.points})` : '-'}</td>
            <td>${entry.third ? `${entry.third.nick} (${entry.third.points})` : '-'}</td>
            <td>${entry.matches}</td>
        </tr>
    `).join('');
        }

        // ========== RESET MATCH ==========
        function resetMatch() {
            blueTeam = [];
            redTeam = [];
            document.getElementById('teamsSection').classList.add('hidden');
        }

        // ========== EVENTOS ==========
        document.getElementById('playerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addNewPlayer();
        });

        // ========== INICIALIZAR ==========
        loadData();
    </script>
</body>

</html>
