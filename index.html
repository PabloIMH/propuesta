<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCRIM MANAGER 3.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 11, 46, 0.95) 50%, rgba(22, 0, 59, 0.95) 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://cloudfront-us-east-1.images.arcpublishing.com/copesa/U7ECE2CH7NGAZNDXS3NM7BLLKQ.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.15;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 255, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #00ffff);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #00ffff;
            margin-top: 10px;
            letter-spacing: 3px;
        }

        .tournament-progress {
            text-align: center;
            font-size: 1.3rem;
            color: #ff00ff;
            margin-top: 10px;
            font-family: 'Orbitron', sans-serif;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        /* SELECTOR DE MODO DE JUEGO */
        .game-mode-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .game-mode-btn {
            padding: 15px 40px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            color: #00ffff;
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .game-mode-btn.active {
            background: linear-gradient(45deg, #00ffff, #0099ff);
            color: #000;
            border-color: #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .game-mode-btn:hover:not(.active) {
            border-color: rgba(0, 255, 255, 0.6);
            transform: translateY(-3px);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: #00ffff;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: #ff00ff;
            margin: 20px 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            background: rgba(10, 10, 30, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #00ffff, #0099ff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff0080, #ff0040);
        }

        .btn-success {
            background: linear-gradient(45deg, #00ff88, #00cc66);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffaa00, #ff6600);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 30px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #00ffff;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #00ffff, #0099ff);
            color: #000;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        /* SWITCH TOGGLE */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 10px;
            border: 2px dashed rgba(255, 0, 255, 0.3);
            position: relative;
            z-index: 20;
        }

        .switch-label {
            font-size: 1.1rem;
            color: #ff00ff;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(100, 100, 150, 0.3);
            transition: .4s;
            border-radius: 34px;
            border: 2px solid rgba(0, 255, 255, 0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 2px;
            background-color: #00ffff;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        input:checked+.slider {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
            background-color: #ff00ff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
        }

        /* MODO CAPITANES */
        .captains-mode {
            margin: 20px 0;
            padding: 20px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 10px;
            border: 2px solid rgba(255, 0, 255, 0.3);
        }

        .captains-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .captain-card {
            padding: 20px;
            background: rgba(20, 20, 40, 0.9);
            border: 3px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .captain-card:hover {
            transform: translateY(-5px);
        }

        .captain-card.blue {
            border-color: rgba(0, 150, 255, 0.6);
            box-shadow: 0 5px 20px rgba(0, 150, 255, 0.3);
        }

        .captain-card.red {
            border-color: rgba(255, 0, 80, 0.6);
            box-shadow: 0 5px 20px rgba(255, 0, 80, 0.3);
        }

        .captain-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
        }

        .captain-card.blue .captain-name {
            color: #0096ff;
            text-shadow: 0 0 15px rgba(0, 150, 255, 0.6);
        }

        .captain-card.red .captain-name {
            color: #ff0080;
            text-shadow: 0 0 15px rgba(255, 0, 80, 0.6);
        }

        .captain-select-wrapper {
            position: relative;
        }

        .captain-select-wrapper select {
            width: 100%;
            padding: 15px;
            padding-right: 40px;
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
        }

        .captain-select-wrapper select:hover {
            border-color: rgba(0, 255, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .captain-select-wrapper select:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5);
        }

        .captain-select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #00ffff;
            pointer-events: none;
            font-size: 1.2rem;
        }

        .captain-select-wrapper.blue select {
            border-color: rgba(0, 150, 255, 0.5);
        }

        .captain-select-wrapper.blue select:hover,
        .captain-select-wrapper.blue select:focus {
            border-color: #0096ff;
            box-shadow: 0 0 25px rgba(0, 150, 255, 0.5);
        }

        .captain-select-wrapper.red select {
            border-color: rgba(255, 0, 80, 0.5);
        }

        .captain-select-wrapper.red select:hover,
        .captain-select-wrapper.red select:focus {
            border-color: #ff0080;
            box-shadow: 0 0 25px rgba(255, 0, 80, 0.5);
        }

        /* INTERFAZ DE SELECCI√ìN DE CAPITANES */
        .captain-selection-interface {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            background: rgba(20, 20, 40, 0.98);
            border: 3px solid rgba(0, 255, 255, 0.6);
            border-radius: 20px;
            padding: 40px;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
        }

        .captain-interface-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
            color: #00ffff;
            text-transform: uppercase;
        }

        .turn-indicator {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border: 2px solid rgba(255, 0, 255, 0.6);
            border-radius: 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .turn-indicator.blue {
            border-color: rgba(0, 150, 255, 0.6);
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.2), rgba(0, 255, 255, 0.2));
            color: #0096ff;
        }

        .turn-indicator.red {
            border-color: rgba(255, 0, 80, 0.6);
            background: linear-gradient(135deg, rgba(255, 0, 80, 0.2), rgba(255, 0, 255, 0.2));
            color: #ff0080;
        }

        .available-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 15px;
            border: 2px dashed rgba(255, 0, 255, 0.3);
        }

        .selectable-player {
            padding: 15px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(100, 100, 150, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .selectable-player:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: rgba(0, 255, 255, 0.8);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.4);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
        }

        .captain-teams-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .captain-team-preview {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            padding: 25px;
            min-height: 300px;
        }

        .captain-team-preview.blue {
            border: 3px solid rgba(0, 150, 255, 0.6);
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.3);
        }

        .captain-team-preview.red {
            border: 3px solid rgba(255, 0, 80, 0.6);
            box-shadow: 0 0 30px rgba(255, 0, 80, 0.3);
        }

        .captain-team-preview h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .captain-team-preview.blue h3 {
            color: #0096ff;
            text-shadow: 0 0 20px rgba(0, 150, 255, 0.8);
        }

        .captain-team-preview.red h3 {
            color: #ff0080;
            text-shadow: 0 0 20px rgba(255, 0, 80, 0.8);
        }

        .captain-team-list {
            list-style: none;
        }

        .captain-team-list li {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1.2rem;
            animation: slideIn 0.5s ease;
        }

        .captain-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 10px;
        }

        .finish-selection-btn {
            width: 100%;
            margin-top: 30px;
        }

        .all-players {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 8px;
            border: 2px dashed rgba(255, 0, 255, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .player-card {
            padding: 12px;
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid rgba(100, 100, 150, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1rem;
            animation: playerAppear 0.4s ease;
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .player-card.selected {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(255, 0, 255, 0.3));
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        .player-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .player-card .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ff0040;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .player-card:hover .delete-btn {
            opacity: 1;
        }

        .player-pool {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 80px;
            padding: 15px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 8px;
            border: 2px dashed rgba(0, 255, 255, 0.2);
        }

        .player-tag {
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border: 1px solid rgba(0, 255, 255, 0.5);
            border-radius: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: playerAppear 0.4s ease;
            transition: all 0.3s ease;
        }

        .player-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .player-tag .remove {
            cursor: pointer;
            color: #ff0080;
            font-weight: bold;
            font-size: 1.2rem;
        }

        @keyframes playerAppear {
            from {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }

            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .team {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .team.blue {
            border: 3px solid rgba(0, 150, 255, 0.6);
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.3);
        }

        .team.red {
            border: 3px solid rgba(255, 0, 80, 0.6);
            box-shadow: 0 0 30px rgba(255, 0, 80, 0.3);
        }

        .team::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: teamGlow 4s ease-in-out infinite;
        }

        @keyframes teamGlow {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(10%, 10%);
            }
        }

        .team-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .team.blue .team-title {
            color: #0096ff;
            text-shadow: 0 0 20px rgba(0, 150, 255, 0.8);
        }

        .team.red .team-title {
            color: #ff0080;
            text-shadow: 0 0 20px rgba(255, 0, 80, 0.8);
        }

        .team-players {
            list-style: none;
            position: relative;
            z-index: 1;
        }

        .team-players li {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1.2rem;
            animation: slideIn 0.5s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-role {
            font-size: 1rem;
            color: #ff00ff;
            font-weight: 700;
            padding: 4px 12px;
            background: rgba(255, 0, 255, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(255, 0, 255, 0.4);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .winner-btns {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
        }

        .role-announcement {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border: 3px solid rgba(255, 0, 255, 0.6);
            border-radius: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        .role-announcement-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #ff00ff;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .role-announcement-role {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: #00ffff;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 0, 255, 0.8);
            }
        }

        .leaderboard {
            margin-top: 40px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            overflow: hidden;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            padding: 15px;
            text-align: left;
            font-size: 1.2rem;
            font-family: 'Orbitron', sans-serif;
            color: #00ffff;
            text-transform: uppercase;
        }

        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            font-size: 1.1rem;
        }

        .leaderboard-table tr:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        .rank {
            font-weight: 700;
            font-size: 1.3rem;
        }

        .rank.gold {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .rank.silver {
            color: #c0c0c0;
            text-shadow: 0 0 10px #c0c0c0;
        }

        .rank.bronze {
            color: #cd7f32;
            text-shadow: 0 0 10px #cd7f32;
        }

        .shuffle-animation {
            animation: shuffle 0.5s ease;
        }

        @keyframes shuffle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        .victory-animation {
            animation: victory 1s ease;
        }

        @keyframes victory {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 50px currentColor;
            }

            100% {
                transform: scale(1);
            }
        }

        .hidden {
            display: none;
        }

        /* Custom Alert */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(20, 20, 40, 0.98);
            border: 3px solid rgba(0, 255, 255, 0.6);
            border-radius: 20px;
            padding: 40px;
            min-width: 400px;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
            z-index: 10000;
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .custom-alert.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .custom-alert .alert-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: #00ffff;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
        }

        .custom-alert .alert-message {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }

        .custom-alert .alert-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .alert-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* History Table */
        .history-section {
            margin-top: 40px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            overflow: hidden;
        }

        .history-table th {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(0, 255, 255, 0.2));
            padding: 15px;
            text-align: left;
            font-size: 1.1rem;
            font-family: 'Orbitron', sans-serif;
            color: #ff00ff;
            text-transform: uppercase;
        }

        .history-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 0, 255, 0.1);
            font-size: 1rem;
        }

        /* Iconos de ayuda (tooltips) */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: 8px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.5);
            font-size: 0.8rem;
            cursor: help;
            position: relative;
            color: #00ffff;
            z-index: 50;
        }

        .help-tooltip {
            position: fixed;
            background: rgba(10, 10, 30, 0.98);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 255, 0.6);
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .help-tooltip.show {
            opacity: 1;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: rgba(0, 255, 255, 0.6) transparent transparent transparent;
        }

        /* LOADER GLOBAL */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 6px solid rgba(0, 255, 255, 0.1);
            border-top-color: #00ffff;
            border-right-color: #ff00ff;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            margin-bottom: 25px;
        }

        .loading-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .loading-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            color: #00ffff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .loading-message {
            font-size: 1.1rem;
            color: #ffffff;
            opacity: 0.9;
            text-align: center;
            max-width: 420px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .history-table tr:hover {
            background: rgba(255, 0, 255, 0.1);
        }

        @media (max-width: 968px) {

            .main-grid,
            .teams-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2.5rem;
            }

            .all-players {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .custom-alert {
                min-width: 90%;
            }

            .game-mode-selector {
                flex-direction: column;
            }

            .captain-teams-display {
                grid-template-columns: 1fr;
            }
        }
    </style>

<body>
    <!-- TOOLTIP GLOBAL -->
    <div id="helpTooltip" class="help-tooltip"></div>

    <!-- LOADER GLOBAL PARA OPERACIONES LENTAS -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-icon">ü™∞</div>
        <div class="loading-spinner"></div>
        <div class="loading-title">Guardando datos</div>
        <div class="loading-message" id="loadingMessage">
            Esto puede tomar un momento...
        </div>
    </div>

    <div class="alert-overlay" id="alertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <div class="alert-title" id="alertTitle">T√≠tulo</div>
        <div class="alert-message" id="alertMessage">Mensaje</div>
        <div class="alert-buttons" id="alertButtons"></div>
    </div>

    <!-- INTERFAZ DE SELECCI√ìN DE CAPITANES -->
    <div class="alert-overlay" id="captainOverlay"></div>
    <div class="captain-selection-interface hidden" id="captainInterface">
        <h2 class="captain-interface-title">üëë SELECCI√ìN POR CAPITANES</h2>

        <div class="turn-indicator" id="turnIndicator">
            Turno de: <strong id="currentCaptainName">Capit√°n Azul</strong>
        </div>

        <h3 class="section-title" style="text-align: center;">JUGADORES DISPONIBLES</h3>
        <div class="available-players-grid" id="availablePlayers">
            <!-- Se llenar√°n din√°micamente -->
        </div>

        <div class="captain-teams-display">
            <div class="captain-team-preview blue">
                <h3>üíô EQUIPO AZUL</h3>
                <ul class="captain-team-list" id="blueCaptainTeam">
                    <!-- Se llenar√° din√°micamente -->
                </ul>
            </div>

            <div class="captain-team-preview red">
                <h3>‚ù§Ô∏è EQUIPO ROJO</h3>
                <ul class="captain-team-list" id="redCaptainTeam">
                    <!-- Se llenar√° din√°micamente -->
                </ul>
            </div>
        </div>

        <button class="btn btn-success finish-selection-btn hidden" id="finishSelectionBtn"
            onclick="finishCaptainSelection()">
            ‚úÖ FINALIZAR SELECCI√ìN
        </button>
    </div>

    <div class="container">
        <header>
            <h1>‚öîÔ∏è SCRIMS ANTIVENEKOS ‚öîÔ∏è</h1>
            <div class="subtitle">SISTEMA PARA TROLLS</div>
            <div class="tournament-progress" id="tournamentProgress">Sin torneo activo</div>
        </header>

        <!-- SELECTOR DE MODO DE JUEGO -->
        <div class="game-mode-selector">
            <button class="game-mode-btn" onclick="setGameMode(event, 'aram')">
                üéØ ARAM
            </button>
            <button class="game-mode-btn" onclick="setGameMode(event, 'grieta')">
                üó∫Ô∏è GRIETA DEL INVOCADOR
            </button>
        </div>

        <div id="mainContent" class="hidden">
            <div class="main-grid">
                <div class="card">
                    <h2 class="card-title">üéÆ LOBBY</h2>

                    <!-- Agregar nuevo jugador -->
                    <div class="input-group">
                        <input type="text" id="playerInput" placeholder="Agregar nuevo jugador...">
                        <button class="btn btn-small" onclick="addNewPlayer()">+ GUARDAR</button>
                    </div>

                    <!-- Selector de modo -->
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="setMode(event, 3)">3v3</button>
                        <button class="mode-btn" onclick="setMode(event, 4)">4v4</button>
                        <button class="mode-btn" onclick="setMode(event, 5)">5v5</button>
                    </div>

                    <!-- SWITCH SELECTOR DE ROL (Solo ARAM) -->
                    <div class="switch-container" id="aramRoleSwitch">
                        <span class="switch-label">
                            üé≤ Selector de Rol (Todos mismo rol)
                            <span class="help-icon"
                                data-tooltip="Todos los jugadores juegan el mismo rol aleatorio (TOP/JUNGLA/MID/ADC/SUPP).">?</span>
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="aramRoleSelectorToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- SWITCH DRAFT ALEATORIO (Solo Grieta) -->
                    <div class="switch-container hidden" id="grietaDraftSwitch">
                        <span class="switch-label">
                            üéØ Draft Aleatorio (Cada uno rol distinto)
                            <span class="help-icon"
                                data-tooltip="Cada jugador recibe un rol distinto al azar (TOP/JUNGLA/MID/ADC/SUPP).">?</span>
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="grietaDraftToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- MODO CAPITANES (Solo Grieta) -->
                    <div class="hidden" id="grietaCaptainsSection">
                        <div class="switch-container">
                            <span class="switch-label">
                                üëë Modo Capitanes
                                <span class="help-icon"
                                    data-tooltip="Dos capitanes se turnan para elegir a sus compa√±eros de equipo desde el lobby.">?</span>
                            </span>
                            <label class="switch">
                                <input type="checkbox" id="captainsModeToggle" onchange="toggleCaptainsMode()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="captains-mode hidden" id="captainsSelection">
                            <h3 class="section-title">üëë SELECCIONA LOS CAPITANES</h3>
                            <div class="captains-selection">
                                <div class="captain-card blue">
                                    <div class="captain-name">CAPIT√ÅN AZUL üíô</div>
                                    <div class="captain-select-wrapper blue">
                                        <select id="blueCaptainSelect" onchange="selectCaptain('blue')">
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="captain-card red">
                                    <div class="captain-name">CAPIT√ÅN ROJO ‚ù§Ô∏è</div>
                                    <div class="captain-select-wrapper red">
                                        <select id="redCaptainSelect" onchange="selectCaptain('red')">
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Todos los jugadores guardados -->
                    <h3 class="section-title">üë• JUGADORES GUARDADOS</h3>
                    <div class="all-players" id="allPlayers">
                        <!-- Saved players will appear here -->
                    </div>

                    <!-- Jugadores seleccionados para esta partida -->
                    <h3 class="section-title">
                        ‚öîÔ∏è LOBBY ACTUAL 
                        <span id="lobbyCounter" style="font-size: 0.9rem; color: #00ffff; margin-left: 10px;"></span>
                    </h3>
                    <div class="player-pool" id="playerPool">
                        <div style="color: rgba(255,255,255,0.3); width: 100%; text-align: center;">
                            Selecciona jugadores arriba...
                        </div>
                    </div>

                    <button class="btn" style="width: 100%; margin-top: 20px;" onclick="generateTeams()">
                        üé≤ GENERAR EQUIPOS
                    </button>

                    <button class="btn btn-warning" style="width: 100%; margin-top: 10px;"
                        onclick="confirmResetTournament()">
                        üìÖ CERRAR LIGA 
                    </button>
                </div>

                <div class="card">
                    <h2 class="card-title">üèÜ LIGA </h2>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>JUGADOR</th>
                                <th>üèÜ VICTORIAS</th>
                                <th>üéÆ PARTIDAS</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: rgba(255,255,255,0.3);">Sin jugadores
                                    en
                                    la liga</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="teamsSection" class="hidden">
                <!-- ANUNCIO DE ROL (Solo si est√° activo en ARAM) -->
                <div class="role-announcement hidden" id="roleAnnouncement">
                    <div class="role-announcement-title">üé≤ ROL DE ESTA PARTIDA:</div>
                    <div class="role-announcement-role" id="announcedRole">TOP</div>
                </div>

                <div class="teams-container">
                    <div class="team blue">
                        <h3 class="team-title">üíô EQUIPO AZUL</h3>
                        <ul class="team-players" id="blueTeam"></ul>
                    </div>

                    <div class="team red">
                        <h3 class="team-title">‚ù§Ô∏è EQUIPO ROJO</h3>
                        <ul class="team-players" id="redTeam"></ul>
                    </div>
                </div>

                <div class="winner-btns">
                    <button class="btn btn-success" onclick="declareWinner('blue')">
                        GAN√ì AZUL üíô
                    </button>
                    <button class="btn btn-danger" onclick="declareWinner('red')">
                        GAN√ì ROJO ‚ù§Ô∏è
                    </button>
                </div>
            </div>

            <!-- Historial de Torneos -->
            <div class="card history-section">
                <h2 class="card-title">üìú HISTORIAL DE TORNEOS</h2>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>FECHA</th>
                            <th>MODO</th>
                            <th>ü•á PRIMERO</th>
                            <th>ü•à SEGUNDO</th>
                            <th>ü•â TERCERO</th>
                            <th>PARTIDAS</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.3);">Sin torneos
                                registrados</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzYOOwof23WU8kQQEOlbew3YFNNYEJ25PlG9yPybaBTnuSxLhRz72EpQpEyphWTydG3LQ/exec';

        let allPlayers = {}; // Todos los jugadores guardados permanentemente
        let tournamentPlayers = {}; // Jugadores de la liga con puntos y partidas acumulativas (points, matches)
        let selectedPlayers = []; // Jugadores seleccionados para lobby actual
        let mode = 3;
        let gameMode = 'aram'; // 'aram' o 'grieta'
        let lastModeUsed = null; // Para trackear cambios de modo y regenerar combinaciones
        let lastGameModeUsed = null; // Para trackear cambios de gameMode
        let blueTeam = [];
        let redTeam = [];
        let allCombinations = [];
        let usedCombinations = [];
        let currentCombinationIndex = 0;
        let tournamentHistory = [];
        let tournamentActive = false;
        let totalMatchesPlayed = 0; // Contador global de partidas √∫nicas jugadas (no suma por jugador)
        let captainsMode = false;
        let blueCaptain = null;
        let redCaptain = null;
        let currentRole = null; // Para ARAM cuando selector de rol est√° activo
        let playerRoles = {}; // Para Grieta cuando draft est√° activo

        // Variables para modo capitanes
        let captainSelectionActive = false;
        let currentTurn = 'blue'; // 'blue' o 'red'
        let availablePlayersForPick = [];
        let captainBlueTeam = [];
        let captainRedTeam = [];

        const ROLES = ['TOP', 'JUNGLA', 'MID', 'ADC', 'SUPP'];
        const LOADING_MESSAGES = [
            'Esto puede tardar un momento...',
            'Esperando que Jaris atrape la mosca...',
            'Aparecio otra m√°s grande...',
            'Esperando que Tierra termine el Hearthstone...',
            'Apurando la cosa para que Martin no se arrepienta de jugar...',
            'Alban terminando la tercera...',
            'Forense chekeando cuerpos...'
        ];
        let loadingInterval = null;

        // ========== SELECTOR DE MODO DE JUEGO ==========
        function setGameMode(e, mode) {
            // Si hay equipos mostrados, ocultarlos al cambiar de modo
            const teamsSection = document.getElementById('teamsSection');
            if (teamsSection && !teamsSection.classList.contains('hidden')) {
                resetMatch();
            }

            gameMode = mode;

            // Si cambi√≥ el gameMode, resetear combinaciones para regenerarlas
            if (lastGameModeUsed !== null && lastGameModeUsed !== gameMode) {
                allCombinations = [];
                usedCombinations = [];
                currentCombinationIndex = 0;
            }
            lastGameModeUsed = gameMode;

            // Asegurar que los equipos est√©n ocultos y actualizar renderizado de jugadores
            if (teamsSection) {
                teamsSection.classList.add('hidden');
            }
            // Limpiar equipos actuales
            blueTeam = [];
            redTeam = [];
            renderAllPlayers(); // Actualizar renderizado para quitar deshabilitados

            // Actualizar botones activos
            document.querySelectorAll('.game-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (e && e.target) {
                e.target.classList.add('active');
            }

            // Mostrar el contenido principal una vez seleccionado un modo
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.classList.remove('hidden');
            }

            // Mostrar/ocultar opciones seg√∫n el modo
            if (mode === 'aram') {
                document.getElementById('aramRoleSwitch').classList.remove('hidden');
                document.getElementById('grietaDraftSwitch').classList.add('hidden');
                document.getElementById('grietaCaptainsSection').classList.add('hidden');
            } else {
                document.getElementById('aramRoleSwitch').classList.add('hidden');
                document.getElementById('grietaDraftSwitch').classList.remove('hidden');
                document.getElementById('grietaCaptainsSection').classList.remove('hidden');
            }

            // Resetear toggles
            document.getElementById('aramRoleSelectorToggle').checked = false;
            document.getElementById('grietaDraftToggle').checked = false;
            document.getElementById('captainsModeToggle').checked = false;
            captainsMode = false;
            document.getElementById('captainsSelection').classList.add('hidden');
        }

        // ========== SISTEMA DE ALERTAS CUSTOM ==========
        function showAlert(title, message, buttons = [{ text: 'OK', action: null }]) {
            const overlay = document.getElementById('alertOverlay');
            const alert = document.getElementById('customAlert');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            const alertButtons = document.getElementById('alertButtons');

            alertTitle.textContent = title;
            alertMessage.textContent = message;

            alertButtons.innerHTML = buttons.map((btn, index) =>
                `<button class="btn ${btn.danger ? 'btn-danger' : ''}" onclick="handleAlertButton(${index})">${btn.text}</button>`
            ).join('');

            window.alertActions = buttons.map(btn => btn.action);

            overlay.classList.add('show');
            alert.classList.add('show');
        }

        function hideAlert() {
            const overlay = document.getElementById('alertOverlay');
            const alert = document.getElementById('customAlert');
            overlay.classList.remove('show');
            alert.classList.remove('show');
        }

        function handleAlertButton(index) {
            const action = window.alertActions[index];
            hideAlert();
            if (action) action();
        }

        // ========== LOADER GLOBAL ==========
        function showLoading(title = 'Guardando datos', baseMessage = 'Esto puede tomar un momento...') {
            const overlay = document.getElementById('loadingOverlay');
            const titleEl = overlay.querySelector('.loading-title');
            const messageEl = document.getElementById('loadingMessage');

            titleEl.textContent = title;
            let index = 0;
            messageEl.textContent = baseMessage;

            overlay.classList.remove('hidden');

            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                index = (index + 1) % LOADING_MESSAGES.length;
                messageEl.textContent = LOADING_MESSAGES[index];
            }, 2000);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }

        // ========== CARGAR DATOS DESDE GOOGLE SHEETS ==========
        async function loadData() {
            try {
                showLoading('Cargando datos', 'Esto puede tomar un momento...');
                console.log('üì• Cargando datos...');
                const response = await fetch(SHEET_URL);
                const data = await response.json();

                console.log('üìä Datos recibidos:', data);

                // Cargar jugadores guardados
                if (data.players && data.players.length > 0) {
                    allPlayers = {};
                    data.players.forEach(player => {
                        if (player.nick) {
                            allPlayers[player.nick] = {
                                exists: true
                            };
                        }
                    });
                }

                // Cargar estado de la liga actual (puntos acumulativos)
                if (data.tournament) {
                    tournamentPlayers = data.tournament.players || {};
                    // Asegurar que todos los jugadores tengan matches si no lo tienen
                    Object.keys(tournamentPlayers).forEach(nick => {
                        if (!tournamentPlayers[nick].matches) {
                            tournamentPlayers[nick].matches = 0;
                        }
                    });
                    usedCombinations = data.tournament.usedCombinations || [];
                    mode = data.tournament.mode || 3;
                    gameMode = data.tournament.gameMode || 'aram';
                    totalMatchesPlayed = data.tournament.totalMatchesPlayed || 0; // Cargar contador de partidas √∫nicas
                    tournamentActive = Object.keys(tournamentPlayers).length > 0;

                    if (tournamentActive) {
                        selectedPlayers = Object.keys(tournamentPlayers);
                        generateAllCombinations();
                        currentCombinationIndex = usedCombinations.length;
                    }
                }

                // Cargar historial
                if (data.history && data.history.length > 0) {
                    tournamentHistory = data.history;
                }

                renderAllPlayers();
                renderPlayerPool();
                updateLeaderboard();
                updateTournamentProgress();
                updateHistory();
                updateLobbyCounter();

                // Setear modo activo
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.mode-btn')[mode - 3].classList.add('active');

                // Inicializar tracking de modo
                lastModeUsed = mode;
                lastGameModeUsed = gameMode;

                // Setear game mode solo si hay torneo activo,
                // para que en un nuevo torneo el usuario tenga que elegir primero.
                document.querySelectorAll('.game-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (tournamentActive) {
                    if (gameMode === 'aram') {
                        document.querySelectorAll('.game-mode-btn')[0].classList.add('active');
                        setGameMode(null, 'aram');
                    } else {
                        document.querySelectorAll('.game-mode-btn')[1].classList.add('active');
                        setGameMode(null, 'grieta');
                    }
                }

            } catch (error) {
                console.log('Error cargando datos:', error);
            } finally {
                hideLoading();
            }
        }

        // ========== GUARDAR EN GOOGLE SHEETS ==========
        // showLoader controla si se muestra el overlay de carga (true por defecto).
        async function saveToSheet(showLoader = true) {
            try {
                if (showLoader) {
                    showLoading('Guardando datos', 'Esto puede tomar un momento...');
                }
                const data = {
                    players: Object.keys(allPlayers).map(nick => ({ nick })),
                    tournament: {
                        players: tournamentPlayers,
                        usedCombinations: usedCombinations,
                        mode: mode,
                        gameMode: gameMode,
                        totalMatchesPlayed: totalMatchesPlayed // Guardar contador de partidas √∫nicas
                    },
                    history: tournamentHistory
                };

                console.log('üì§ Enviando datos:', data);

                const response = await fetch(SHEET_URL + '?action=save', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const text = await response.text();
                console.log('‚úÖ Respuesta del servidor:', text);

            } catch (error) {
                console.error('‚ùå Error guardando:', error);
                showAlert('‚ö†Ô∏è ERROR', 'No se pudo guardar en Google Sheets. Revisa la consola.');
            } finally {
                if (showLoader) {
                    hideLoading();
                }
            }
        }

        // ========== GESTI√ìN DE JUGADORES ==========
        function renderAllPlayers() {
            const container = document.getElementById('allPlayers');
            const players = Object.keys(allPlayers).sort();

            if (players.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.3);">No hay jugadores guardados</div>';
                return;
            }

            // Solo deshabilitar jugadores si hay equipos mostrados (partida activa) o si el lobby est√° lleno
            const teamsSection = document.getElementById('teamsSection');
            const hasActiveMatch = teamsSection && !teamsSection.classList.contains('hidden');
            const maxPlayers = mode * 2;
            const isLobbyFull = selectedPlayers.length >= maxPlayers;

            container.innerHTML = players.map(nick => {
                const isSelected = selectedPlayers.includes(nick);
                const isDisabled = (hasActiveMatch && !isSelected) || (isLobbyFull && !isSelected);
                
                return `
                <div class="player-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                     onclick="${isDisabled ? '' : `togglePlayer('${nick}')`}">
                    ${nick}
                    <div class="delete-btn" onclick="event.stopPropagation(); confirmDeletePlayer('${nick}')">‚úï</div>
                </div>
            `;
            }).join('');
        }

        function togglePlayer(nick) {
            // Con liga semanal acumulativa, se puede modificar el lobby libremente
            // Solo bloquear si hay equipos mostrados actualmente
            const teamsSection = document.getElementById('teamsSection');
            if (!teamsSection.classList.contains('hidden')) {
                showAlert('‚ö†Ô∏è PARTIDA ACTIVA', 'Termina la partida actual antes de modificar el lobby.');
                return;
            }

            if (selectedPlayers.includes(nick)) {
                // Quitar jugador del lobby
                selectedPlayers = selectedPlayers.filter(p => p !== nick);
                // NO eliminar de tournamentPlayers, mantener estad√≠sticas acumulativas
            } else {
                // Verificar l√≠mite de jugadores seg√∫n el modo seleccionado
                const maxPlayers = mode * 2; // 3v3 = 6, 4v4 = 8, 5v5 = 10
                if (selectedPlayers.length >= maxPlayers) {
                    showAlert('‚ö†Ô∏è LOBBY LLENO', `Ya tienes ${maxPlayers} jugadores seleccionados para el modo ${mode}v${mode}. Quita alguno para agregar otro.`);
                    return;
                }

                selectedPlayers.push(nick);
                // Si el jugador no existe en la liga, inicializarlo con 0 victorias y 0 partidas
                // Si ya existe, mantener sus estad√≠sticas acumulativas
                if (!tournamentPlayers[nick]) {
                    tournamentPlayers[nick] = { points: 0, matches: 0 };
                }
            }

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();
            updateCaptainSelects();
            updateLobbyCounter();
        }

        function renderPlayerPool() {
            const pool = document.getElementById('playerPool');

            if (selectedPlayers.length === 0) {
                pool.innerHTML = '<div style="color: rgba(255,255,255,0.3); width: 100%; text-align: center;">Selecciona jugadores arriba...</div>';
                updateLobbyCounter();
                return;
            }

            pool.innerHTML = selectedPlayers.map(p => `
                <div class="player-tag">
                    <span>${p}</span>
                    <span class="remove" onclick="togglePlayer('${p}')">‚úï</span>
                </div>
            `).join('');

            updateLobbyCounter();
        }

        async function addNewPlayer() {
            const input = document.getElementById('playerInput');
            const nick = input.value.trim();

            if (!nick) {
                showAlert('‚ö†Ô∏è ERROR', 'Por favor escribe un nombre de jugador.');
                input.focus();
                return;
            }

            if (allPlayers[nick]) {
                showAlert('‚ö†Ô∏è YA EXISTE', `El jugador "${nick}" ya est√° guardado.`);
                input.focus();
                return;
            }

            allPlayers[nick] = { exists: true };

            await saveToSheet(true);

            renderAllPlayers();
            updateCaptainSelects();
            input.value = '';
            input.focus();

            showAlert('‚úÖ GUARDADO', `¬°Jugador "${nick}" agregado exitosamente!`);
        }

        function confirmDeletePlayer(nick) {
            showAlert(
                '‚ö†Ô∏è CONFIRMAR',
                `¬øEliminar permanentemente a "${nick}"?`,
                [
                    { text: 'CANCELAR', action: null },
                    { text: 'ELIMINAR', danger: true, action: () => deletePlayer(nick) }
                ]
            );
        }

        async function deletePlayer(nick) {
            delete allPlayers[nick];
            selectedPlayers = selectedPlayers.filter(p => p !== nick);
            delete tournamentPlayers[nick];

            await saveToSheet(true);

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();
            updateCaptainSelects();

            showAlert('‚úÖ ELIMINADO', `Jugador "${nick}" eliminado correctamente.`);
        }

        // ========== ACTUALIZAR CONTADOR DE LOBBY ==========
        function updateLobbyCounter() {
            const counter = document.getElementById('lobbyCounter');
            if (!counter) return;

            const required = mode * 2;
            const current = selectedPlayers.length;
            let color = '#00ffff'; // Por defecto cyan
            
            if (current >= required) {
                color = '#00ff88'; // Verde cuando est√° completo
            } else if (current > 0) {
                color = '#ffaa00'; // Naranja cuando tiene algunos pero no suficientes
            }
            
            counter.textContent = `(${current}/${required})`;
            counter.style.color = color;
            
            // Si el lobby est√° lleno, mostrar un indicador visual
            if (current >= required) {
                counter.textContent += ' ‚úì';
            }
        }

        // ========== SELECTOR DE MODO ==========
        function setMode(e, newMode) {
            // Con liga semanal acumulativa, se puede cambiar el tama√±o libremente
            // Solo bloquear si hay equipos mostrados actualmente
            const teamsSection = document.getElementById('teamsSection');
            if (!teamsSection.classList.contains('hidden')) {
                showAlert('‚ö†Ô∏è PARTIDA ACTIVA', 'Termina la partida actual antes de cambiar el tama√±o del equipo.');
                return;
            }

            mode = newMode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (e && e.target) {
                e.target.classList.add('active');
            }

            // Si cambi√≥ el modo, resetear combinaciones para regenerarlas
            if (lastModeUsed !== null && lastModeUsed !== mode) {
                allCombinations = [];
                usedCombinations = [];
                currentCombinationIndex = 0;
            }
            lastModeUsed = mode;

            // Asegurar que los equipos est√©n ocultos y actualizar renderizado de jugadores
            if (teamsSection) {
                teamsSection.classList.add('hidden');
            }
            // Limpiar equipos actuales
            blueTeam = [];
            redTeam = [];
            renderAllPlayers(); // Actualizar renderizado para quitar deshabilitados
            updateLobbyCounter();
        }

        // ========== MODO CAPITANES ==========
        function toggleCaptainsMode() {
            captainsMode = document.getElementById('captainsModeToggle').checked;

            if (captainsMode) {
                document.getElementById('captainsSelection').classList.remove('hidden');
                updateCaptainSelects();
            } else {
                document.getElementById('captainsSelection').classList.add('hidden');
                blueCaptain = null;
                redCaptain = null;

                // Si se desactiva el modo capitanes en medio de una selecci√≥n, cerrar la interfaz
                if (captainSelectionActive) {
                    document.getElementById('captainOverlay').classList.remove('show');
                    document.getElementById('captainInterface').classList.add('hidden');
                    captainSelectionActive = false;
                }
            }
        }

        function updateCaptainSelects() {
            const blueSelect = document.getElementById('blueCaptainSelect');
            const redSelect = document.getElementById('redCaptainSelect');

            const options = '<option value="">Seleccionar...</option>' +
                selectedPlayers.map(p => `<option value="${p}">${p}</option>`).join('');

            blueSelect.innerHTML = options;
            redSelect.innerHTML = options;

            if (blueCaptain) blueSelect.value = blueCaptain;
            if (redCaptain) redSelect.value = redCaptain;
        }

        function selectCaptain(team) {
            const select = document.getElementById(team + 'CaptainSelect');
            const captain = select.value;

            if (team === 'blue') {
                blueCaptain = captain;
            } else {
                redCaptain = captain;
            }
        }

        // ========== INTERFAZ DE SELECCI√ìN DE CAPITANES ==========
        function startCaptainSelection() {
            // Preparar jugadores disponibles (todos menos los capitanes)
            availablePlayersForPick = selectedPlayers.filter(p => p !== blueCaptain && p !== redCaptain);

            // Inicializar equipos con los capitanes
            captainBlueTeam = [blueCaptain];
            captainRedTeam = [redCaptain];

            // Resetear turno
            currentTurn = 'blue';

            // Mostrar interfaz
            document.getElementById('captainOverlay').classList.add('show');
            document.getElementById('captainInterface').classList.remove('hidden');

            captainSelectionActive = true;

            updateCaptainInterface();
        }

        function updateCaptainInterface() {
            // Actualizar indicador de turno
            const turnIndicator = document.getElementById('turnIndicator');
            const currentCaptainName = document.getElementById('currentCaptainName');

            if (currentTurn === 'blue') {
                turnIndicator.className = 'turn-indicator blue';
                currentCaptainName.textContent = `Capit√°n Azul (${blueCaptain})`;
            } else {
                turnIndicator.className = 'turn-indicator red';
                currentCaptainName.textContent = `Capit√°n Rojo (${redCaptain})`;
            }

            // Renderizar jugadores disponibles
            const availableContainer = document.getElementById('availablePlayers');
            if (availablePlayersForPick.length === 0) {
                availableContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.5); font-size: 1.2rem;">No quedan jugadores por elegir</div>';
                document.getElementById('finishSelectionBtn').classList.remove('hidden');
            } else {
                availableContainer.innerHTML = availablePlayersForPick.map(player => `
                    <div class="selectable-player" onclick="pickPlayer('${player}')">
                        ${player}
                    </div>
                `).join('');
            }

            // Actualizar vista previa de equipos
            document.getElementById('blueCaptainTeam').innerHTML = captainBlueTeam.map((p, i) => `
                <li>‚öîÔ∏è ${p} ${i === 0 ? '<span class="captain-badge">CAPIT√ÅN</span>' : ''}</li>
            `).join('');

            document.getElementById('redCaptainTeam').innerHTML = captainRedTeam.map((p, i) => `
                <li>‚öîÔ∏è ${p} ${i === 0 ? '<span class="captain-badge">CAPIT√ÅN</span>' : ''}</li>
            `).join('');
        }

        function pickPlayer(player) {
            // Agregar jugador al equipo del capit√°n actual
            if (currentTurn === 'blue') {
                captainBlueTeam.push(player);
            } else {
                captainRedTeam.push(player);
            }

            // Quitar jugador de disponibles
            availablePlayersForPick = availablePlayersForPick.filter(p => p !== player);

            // Cambiar turno
            currentTurn = currentTurn === 'blue' ? 'red' : 'blue';

            // Actualizar interfaz
            updateCaptainInterface();
        }

        function finishCaptainSelection() {
            // Asignar equipos finales
            blueTeam = captainBlueTeam;
            redTeam = captainRedTeam;

            // Cerrar interfaz
            document.getElementById('captainOverlay').classList.remove('show');
            document.getElementById('captainInterface').classList.add('hidden');
            captainSelectionActive = false;

            // Mostrar equipos finales
            displayFinalTeams();
        }

        function displayFinalTeams() {
            // Asignar roles si draft est√° activo
            if (gameMode === 'grieta' && document.getElementById('grietaDraftToggle').checked) {
                const shuffledRoles = [...ROLES].sort(() => Math.random() - 0.5);
                playerRoles = {};

                blueTeam.forEach((player, index) => {
                    playerRoles[player] = shuffledRoles[index];
                });

                const shuffledRoles2 = [...ROLES].sort(() => Math.random() - 0.5);
                redTeam.forEach((player, index) => {
                    playerRoles[player] = shuffledRoles2[index];
                });

                document.getElementById('blueTeam').innerHTML = blueTeam.map(p =>
                    `<li><span>‚öîÔ∏è ${p}</span><span class="player-role">${playerRoles[p]}</span></li>`
                ).join('');
                document.getElementById('redTeam').innerHTML = redTeam.map(p =>
                    `<li><span>‚öîÔ∏è ${p}</span><span class="player-role">${playerRoles[p]}</span></li>`
                ).join('');
            } else {
                document.getElementById('blueTeam').innerHTML = blueTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');
                document.getElementById('redTeam').innerHTML = redTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');
            }

            document.getElementById('teamsSection').classList.remove('hidden');

            // Inicializar jugadores en la liga si no existen (mantener estad√≠sticas acumulativas)
            [...blueTeam, ...redTeam].forEach(player => {
                if (!tournamentPlayers[player]) {
                    tournamentPlayers[player] = { points: 0, matches: 0 };
                }
            });

            // Guardar en combinaciones usadas (modo capitanes no usa combinaciones)
            if (!tournamentActive) {
                tournamentActive = true;
            }

            // Guardar en segundo plano sin bloquear la UI
            saveToSheet(false);
        }

        // ========== SISTEMA DE COMBINACIONES ==========
        function generateAllCombinations() {
            const players = [...selectedPlayers];
            const teamSize = mode;
            allCombinations = [];

            // Generar todas las combinaciones posibles
            function combine(arr, size) {
                const result = [];

                function helper(start, combo) {
                    if (combo.length === size) {
                        result.push([...combo]);
                        return;
                    }

                    for (let i = start; i < arr.length; i++) {
                        combo.push(arr[i]);
                        helper(i + 1, combo);
                        combo.pop();
                    }
                }

                helper(0, []);
                return result;
            }

            const team1Combos = combine(players, teamSize);

            team1Combos.forEach(team1 => {
                const team2 = players.filter(p => !team1.includes(p));
                if (team2.length === teamSize) {
                    // Evitar duplicados (A vs B es igual a B vs A)
                    const combo = {
                        blue: team1.sort(),
                        red: team2.sort()
                    };

                    const comboStr = JSON.stringify(combo);
                    const reverseCombo = JSON.stringify({ blue: combo.red, red: combo.blue });

                    if (!allCombinations.some(c =>
                        JSON.stringify(c) === comboStr || JSON.stringify(c) === reverseCombo
                    )) {
                        allCombinations.push(combo);
                    }
                }
            });
        }

        function getNextCombination() {
            if (!allCombinations.length) {
                generateAllCombinations();
            }

            if (usedCombinations.length >= allCombinations.length) {
                // Se complet√≥ el ciclo, reiniciar
                usedCombinations = [];
                currentCombinationIndex = 0;
                showAlert('üîÑ CICLO COMPLETO', '¬°Se jugaron todas las combinaciones posibles! Reiniciando ciclo...');
            }

            const nextCombo = allCombinations[currentCombinationIndex];
            usedCombinations.push(currentCombinationIndex);
            currentCombinationIndex++;

            return nextCombo;
        }

        // ========== GENERAR EQUIPOS ==========
        function generateTeams() {
            const required = mode * 2;

            if (selectedPlayers.length < required) {
                showAlert('‚ö†Ô∏è JUGADORES INSUFICIENTES', `Necesitas ${required} jugadores para el modo ${mode}v${mode}.`);
                return;
            }

            // Validar modo capitanes
            if (captainsMode && gameMode === 'grieta') {
                if (!blueCaptain || !redCaptain) {
                    showAlert('‚ö†Ô∏è FALTA CAPIT√ÅN', 'Debes seleccionar ambos capitanes primero.');
                    return;
                }
                if (blueCaptain === redCaptain) {
                    showAlert('‚ö†Ô∏è ERROR', 'Los capitanes deben ser diferentes.');
                    return;
                }

                // Iniciar selecci√≥n por capitanes
                if (!tournamentActive) {
                    tournamentActive = true;
                    // Inicializar jugadores si no existen, pero mantener estad√≠sticas acumulativas
                    selectedPlayers.forEach(p => {
                        if (!tournamentPlayers[p]) {
                            tournamentPlayers[p] = { points: 0, matches: 0 };
                        }
                    });
                }

                startCaptainSelection();
                return;
            }

            // Si cambi√≥ el modo o gameMode, regenerar combinaciones
            if (lastModeUsed !== mode || lastGameModeUsed !== gameMode) {
                allCombinations = [];
                usedCombinations = [];
                currentCombinationIndex = 0;
                lastModeUsed = mode;
                lastGameModeUsed = gameMode;
            }

            if (!tournamentActive) {
                // Iniciar nueva sesi√≥n de partidas (las estad√≠sticas son acumulativas)
                tournamentActive = true;

                // Inicializar jugadores si no existen, pero mantener estad√≠sticas acumulativas
                selectedPlayers.forEach(p => {
                    if (!tournamentPlayers[p]) {
                        tournamentPlayers[p] = { points: 0, matches: 0 };
                    }
                });
            }

            // Siempre regenerar combinaciones para asegurar que usan el modo actual
            generateAllCombinations();

            const pool = document.getElementById('playerPool');
            pool.classList.add('shuffle-animation');

            setTimeout(() => {
                const combo = getNextCombination();
                blueTeam = combo.blue;
                redTeam = combo.red;

                // Asignar roles seg√∫n el modo
                if (gameMode === 'aram' && document.getElementById('aramRoleSelectorToggle').checked) {
                    // ARAM: Un solo rol para todos
                    currentRole = ROLES[Math.floor(Math.random() * ROLES.length)];
                    document.getElementById('roleAnnouncement').classList.remove('hidden');
                    document.getElementById('announcedRole').textContent = currentRole;

                    document.getElementById('blueTeam').innerHTML = blueTeam.map(p => `<li><span>‚öîÔ∏è ${p}</span></li>`).join('');
                    document.getElementById('redTeam').innerHTML = redTeam.map(p => `<li><span>‚öîÔ∏è ${p}</span></li>`).join('');

                } else if (gameMode === 'grieta' && document.getElementById('grietaDraftToggle').checked) {
                    // GRIETA: Draft aleatorio - cada jugador un rol distinto
                    const shuffledRoles = [...ROLES].sort(() => Math.random() - 0.5);
                    playerRoles = {};

                    blueTeam.forEach((player, index) => {
                        playerRoles[player] = shuffledRoles[index];
                    });

                    const shuffledRoles2 = [...ROLES].sort(() => Math.random() - 0.5);
                    redTeam.forEach((player, index) => {
                        playerRoles[player] = shuffledRoles2[index];
                    });

                    document.getElementById('roleAnnouncement').classList.add('hidden');

                    document.getElementById('blueTeam').innerHTML = blueTeam.map(p =>
                        `<li><span>‚öîÔ∏è ${p}</span><span class="player-role">${playerRoles[p]}</span></li>`
                    ).join('');
                    document.getElementById('redTeam').innerHTML = redTeam.map(p =>
                        `<li><span>‚öîÔ∏è ${p}</span><span class="player-role">${playerRoles[p]}</span></li>`
                    ).join('');

                } else {
                    // Sin roles
                    currentRole = null;
                    playerRoles = {};
                    document.getElementById('roleAnnouncement').classList.add('hidden');

                    document.getElementById('blueTeam').innerHTML = blueTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');
                    document.getElementById('redTeam').innerHTML = redTeam.map(p => `<li>‚öîÔ∏è ${p}</li>`).join('');
                }

                document.getElementById('teamsSection').classList.remove('hidden');
                pool.classList.remove('shuffle-animation');

                updateTournamentProgress();
                // Guardar en segundo plano sin mostrar loader (la generaci√≥n de equipos debe ser instant√°nea)
                saveToSheet(false);
            }, 500);
        }

        // ========== DECLARAR GANADOR ==========
        async function declareWinner(team) {
            const winners = team === 'blue' ? blueTeam : redTeam;
            const losers = team === 'blue' ? redTeam : blueTeam;
            const teamElement = document.querySelector(`.team.${team}`);

            teamElement.classList.add('victory-animation');

            // Sumar victoria a los ganadores
            winners.forEach(player => {
                if (!tournamentPlayers[player]) {
                    tournamentPlayers[player] = { points: 0, matches: 0 };
                }
                tournamentPlayers[player].points += 1;
                tournamentPlayers[player].matches += 1;
            });

            // Sumar partida (sin victoria) a los perdedores
            losers.forEach(player => {
                if (!tournamentPlayers[player]) {
                    tournamentPlayers[player] = { points: 0, matches: 0 };
                }
                tournamentPlayers[player].matches += 1;
            });

            // Incrementar contador global de partidas √∫nicas (solo una vez por partida, no por jugador)
            totalMatchesPlayed += 1;

            await saveToSheet(true);
            updateLeaderboard();
            updateTournamentProgress();

            setTimeout(() => {
                resetMatch();
                teamElement.classList.remove('victory-animation');
                renderAllPlayers(); // Actualizar renderizado para habilitar jugadores nuevamente
            }, 1000);
        }

        // ========== ACTUALIZAR TABLA ==========
        function updateLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            const sorted = Object.entries(tournamentPlayers)
                .sort((a, b) => {
                    // Ordenar primero por victorias, luego por partidas (m√°s partidas = mejor si empatan)
                    if (b[1].points !== a[1].points) {
                        return b[1].points - a[1].points;
                    }
                    return b[1].matches - a[1].matches;
                });

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: rgba(255,255,255,0.3);">Sin jugadores en la liga</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(([nick, stats], index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';

                const points = stats.points || 0;
                const matches = stats.matches || 0;

                return `
                    <tr>
                        <td class="rank ${rankClass}">${index + 1}</td>
                        <td>${nick}</td>
                        <td>${points}</td>
                        <td>${matches}</td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PROGRESO DE LA LIGA ==========
        function updateTournamentProgress() {
            const progressElement = document.getElementById('tournamentProgress');
            if (!progressElement) return;
            
            // Calcular el n√∫mero total de partidas jugadas
            const matchCount = Math.max(
                ...Object.values(tournamentPlayers).map(p => p.matches || 0),
                0
            );
            
            // Mostrar siempre el contador de partidas
            progressElement.textContent = `Partidas de esta liga: ${matchCount}`;
            
            // Mantener el tooltip con informaci√≥n detallada
            const totalWins = Object.values(tournamentPlayers).reduce((sum, player) => sum + (player.points || 0), 0);
            const playerCount = Object.keys(tournamentPlayers).length;
            
            progressElement.title = `Modo: ${gameMode === 'aram' ? 'ARAM' : 'Grieta del Invocador'}\n` +
                                 `Jugadores en el lobby: ${playerCount}\n` +
                                 `Partidas jugadas: ${matchCount}\n` +
                                 `Victorias totales: ${totalWins}`;
        }

        // ========== CERRAR LIGA  ==========
        function confirmResetTournament() {
            const playerCount = Object.keys(tournamentPlayers).length;
            if (playerCount === 0) {
                showAlert('‚ö†Ô∏è SIN JUGADORES', 'No hay jugadores en la liga para cerrar.');
                return;
            }

            showAlert(
                'üìÖ CERRAR LIGA ',
                '¬øCerrar la liga y guardar en el historial?',
                [
                    { text: 'CANCELAR', action: null },
                    { text: 'CERRAR LIGA', danger: true, action: resetTournament }
                ]
            );
        }

        async function resetTournament() {
            // Guardar en historial con m√°s detalles
            const sorted = Object.entries(tournamentPlayers)
                .sort((a, b) => {
                    if (b[1].points !== a[1].points) {
                        return b[1].points - a[1].points;
                    }
                    return b[1].matches - a[1].matches;
                });

            const top3 = sorted.slice(0, 3);
            const totalPlayers = sorted.length;

            const historyEntry = {
                date: new Date().toLocaleString('es-CL'),
                gameMode: 'Liga Semanal', // Ya no es solo ARAM o Grieta, es acumulativo
                first: top3[0] ? {
                    nick: top3[0][0],
                    points: top3[0][1].points || 0,
                    matches: top3[0][1].matches || 0
                } : null,
                second: top3[1] ? {
                    nick: top3[1][0],
                    points: top3[1][1].points || 0,
                    matches: top3[1][1].matches || 0
                } : null,
                third: top3[2] ? {
                    nick: top3[2][0],
                    points: top3[2][1].points || 0,
                    matches: top3[2][1].matches || 0
                } : null,
                matches: `${totalMatchesPlayed} partidas | ${totalPlayers} jugadores`
            };

            tournamentHistory.unshift(historyEntry);

            // Resetear estad√≠sticas para nueva semana
            tournamentPlayers = {};
            selectedPlayers = [];
            usedCombinations = [];
            currentCombinationIndex = 0;
            allCombinations = [];
            tournamentActive = false;
            totalMatchesPlayed = 0; // Resetear contador de partidas √∫nicas
            blueTeam = [];
            redTeam = [];
            currentRole = null;
            playerRoles = {};

            await saveToSheet(true);

            renderAllPlayers();
            renderPlayerPool();
            updateLeaderboard();
            updateTournamentProgress();
            updateHistory();
            document.getElementById('teamsSection').classList.add('hidden');

            showAlert('‚úÖ LIGA CERRADA', '¬°Liga semanal guardada en el historial!');
        }

        // ========== HISTORIAL ==========
        function updateHistory() {
            const tbody = document.getElementById('historyBody');

            if (tournamentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.3);">Sin torneos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = tournamentHistory.map(entry => {
                const firstStr = entry.first ? `${entry.first.nick} (${entry.first.points}üèÜ${entry.first.matches ? ` / ${entry.first.matches}üéÆ` : ''})` : '-';
                const secondStr = entry.second ? `${entry.second.nick} (${entry.second.points}üèÜ${entry.second.matches ? ` / ${entry.second.matches}üéÆ` : ''})` : '-';
                const thirdStr = entry.third ? `${entry.third.nick} (${entry.third.points}üèÜ${entry.third.matches ? ` / ${entry.third.matches}üéÆ` : ''})` : '-';
                return `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.gameMode}</td>
                    <td>${firstStr}</td>
                    <td>${secondStr}</td>
                    <td>${thirdStr}</td>
                    <td>${entry.matches}</td>
                </tr>
            `;
            }).join('');
        }

        // ========== RESET MATCH ==========
        function resetMatch() {
            blueTeam = [];
            redTeam = [];
            currentRole = null;
            playerRoles = {};
            document.getElementById('teamsSection').classList.add('hidden');
        }

        // ========== MANEJO DE TOOLTIPS ==========
        function initTooltips() {
            const tooltip = document.getElementById('helpTooltip');
            const helpIcons = document.querySelectorAll('.help-icon');

            helpIcons.forEach(icon => {
                icon.addEventListener('mouseenter', (e) => {
                    const text = icon.getAttribute('data-tooltip');
                    if (!text) return;

                    const rect = icon.getBoundingClientRect();
                    tooltip.textContent = text;
                    tooltip.classList.add('show');

                    // Posicionar arriba del icono, centrado
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    const top = rect.top - tooltipRect.height - 10;

                    // Ajustar si se sale por la izquierda o derecha
                    let finalLeft = left;
                    if (finalLeft < 10) finalLeft = 10;
                    if (finalLeft + tooltipRect.width > window.innerWidth - 10) {
                        finalLeft = window.innerWidth - tooltipRect.width - 10;
                    }

                    tooltip.style.left = finalLeft + 'px';
                    tooltip.style.top = top + 'px';
                });

                icon.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });
        }

        // ========== EVENTOS ==========
        document.getElementById('playerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addNewPlayer();
        });

        // ========== INICIALIZAR ==========
        loadData();
        // Inicializar tooltips despu√©s de que se cargue el contenido
        setTimeout(() => {
            initTooltips();
        }, 100);
    </script>
</body>

</html>
